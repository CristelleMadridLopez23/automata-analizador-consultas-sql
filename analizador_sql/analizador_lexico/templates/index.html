<!-- Plantilla principal para la UI del analizador SQL.
     Variables esperadas en el contexto:
       - filename: nombre del archivo subido
       - source: contenido original del archivo
       - log: lista de strings de progreso
       - errors: lista de mensajes de error
       - tokens: lista de tokens (type, value, line, col)
       - symtab: lista de entradas de tabla de s√≠mbolos
       - stats: estad√≠sticas de la tabla de s√≠mbolos
     Notas:
       - Limitar tama√±o de tokens (ya muestra primeros 2000)
       - Bootstrap 5 para estilo
-->
<!-- Plantilla principal para la UI del analizador SQL con modo oscuro persistente -->
<!doctype html>
<html lang="es"
      x-data="{ showSymbols:false, showSource:false }"
      x-bind:class="Alpine.store('theme').dark ? 'dark' : ''">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Analizador L√©xico de SQL</title>

  <!-- Tailwind + Alpine -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x" defer></script>
  <script>
    tailwind.config = { darkMode: 'class' }

    document.addEventListener('alpine:init', () => {
      Alpine.store('theme', {
        dark: localStorage.getItem('darkMode') === 'true',
        toggle() {
          this.dark = !this.dark;
          localStorage.setItem('darkMode', this.dark);
        }
      });
    });
  </script>
</head>

<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen">
  <div class="max-w-7xl mx-auto px-6 py-10">

    <!-- HEADER -->
    <header class="flex items-center justify-between mb-10">
      <div class="flex-1 text-center">
        <h1 class="text-3xl font-bold mb-2">üîç Analizador L√©xico de SQL</h1>
        <p class="text-slate-500 dark:text-slate-400">
          Carga un archivo .sql para tokenizar, validar y ver la tabla de s√≠mbolos.
        </p>
      </div>

      <!-- TOGGLE MODO OSCURO -->
      <label class="flex items-center gap-2 absolute top-6 right-8 cursor-pointer">
        <span class="text-sm">Modo oscuro</span>
        <input type="checkbox" class="sr-only"
               @change="Alpine.store('theme').toggle()"
               :checked="Alpine.store('theme').dark">
        <div class="w-11 h-6 bg-slate-300 dark:bg-slate-700 rounded-full relative transition">
          <div class="absolute top-0.5 left-0.5 w-5 h-5 bg-white dark:bg-slate-200 rounded-full transition-transform"
               :class="Alpine.store('theme').dark ? 'translate-x-5' : ''"></div>
        </div>
      </label>
    </header>

    <!-- UPLOAD -->
    <section class="bg-white dark:bg-slate-800 rounded-2xl shadow ring-1 ring-slate-200 dark:ring-slate-700 p-6 mb-8">
      <form method="post" enctype="multipart/form-data"
            class="grid sm:grid-cols-[1fr_auto] gap-4 items-end">
        {% csrf_token %}
        <div>
          <label class="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">
            Archivo .sql
          </label>
          <input type="file" name="sqlfile" accept=".sql,.txt"
                 class="w-full text-sm border border-slate-300 dark:border-slate-700 rounded-lg
                        file:bg-indigo-600 file:text-white file:border-0 file:rounded-lg
                        file:px-4 file:py-2 hover:file:bg-indigo-700">
        </div>
        <button class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-6 py-2.5 font-semibold">
          Analizar
        </button>
      </form>

      {% if filename %}
      <p class="mt-3 text-sm text-slate-500 dark:text-slate-400">
        Archivo seleccionado: <span class="font-semibold">{{ filename }}</span>
      </p>
      {% endif %}
    </section>

    <!-- PROGRESO -->
    {% if log %}
    <section class="bg-white dark:bg-slate-800 rounded-2xl shadow ring-1 ring-slate-200 dark:ring-slate-700 p-6 mb-8">
      <h2 class="text-lg font-semibold mb-3">Progreso</h2>
      <ul class="space-y-1 list-decimal list-inside text-sm">
        {% for l in log %}
        <li>{{ l }}</li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}

    <!-- ERRORES -->
    {% if errors and errors|length > 0 %}
    <section class="rounded-2xl border border-rose-300 dark:border-rose-800 bg-rose-50 dark:bg-rose-900/30 p-6 mb-8">
      <h2 class="text-lg font-semibold text-rose-700 dark:text-rose-300 mb-2">‚ùå Errores encontrados</h2>
      <ul class="text-sm space-y-1">
        {% for e in errors %}
        <li class="font-mono">{{ e }}</li>
        {% endfor %}
      </ul>
    </section>
    {% elif filename %}
    <section class="rounded-2xl border border-emerald-300 dark:border-emerald-800 bg-emerald-50 dark:bg-emerald-900/30 p-6 mb-8">
      <h2 class="text-lg font-semibold text-emerald-700 dark:text-emerald-300">‚úÖ No se encontraron errores de sintaxis.</h2>
      <p class="text-sm text-emerald-700/80 dark:text-emerald-300/80">
        Las producciones soportadas fueron validadas correctamente.
      </p>
    </section>
    {% endif %}

    <!-- TOKENS -->
    {% if tokens %}
    <section class="bg-white dark:bg-slate-800 rounded-2xl shadow ring-1 ring-slate-200 dark:ring-slate-700 p-6 mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Tokens (primeros 2000)</h2>
        <span class="text-sm text-slate-500 dark:text-slate-400">Total: {{ tokens|length }}</span>
      </div>

      <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
        <div class="max-h-80 overflow-y-auto"> <!-- scroll limitado -->
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 dark:bg-slate-900 sticky top-0">
              <tr class="text-left">
                <th class="px-4 py-2">#</th>
                <th class="px-4 py-2">Tipo</th>
                <th class="px-4 py-2">Valor</th>
                <th class="px-4 py-2">L√≠nea</th>
                <th class="px-4 py-2">Col</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
            {% for t in tokens %}
            <tr class="hover:bg-slate-50/70 dark:hover:bg-slate-900/50">
              <td class="px-4 py-2">{{ forloop.counter }}</td>
              <td class="px-4 py-2">
                {% with t.type as kind %}
                  <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold
                    {% if kind == 'RESWORD' %} bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-300
                    {% elif kind == 'IDENT' %} bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-300
                    {% elif kind == 'NUMBER' %} bg-emerald-100 text-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-300
                    {% elif kind == 'STRING' %} bg-fuchsia-100 text-fuchsia-800 dark:bg-fuchsia-900/40 dark:text-fuchsia-300
                    {% elif kind == 'OP' %} bg-sky-100 text-sky-800 dark:bg-sky-900/40 dark:text-sky-300
                    {% elif kind == 'SYMBOL' %} bg-slate-200 text-slate-800 dark:bg-slate-800 dark:text-slate-200
                    {% else %} bg-slate-100 text-slate-700 dark:bg-slate-800/50 dark:text-slate-300 {% endif %}">
                    {{ t.type }}
                  </span>
                {% endwith %}
              </td>
              <td class="px-4 py-2"><code class="font-mono text-[13px]">{{ t.value }}</code></td>
              <td class="px-4 py-2">{{ t.line }}</td>
              <td class="px-4 py-2">{{ t.col }}</td>
            </tr>
            {% endfor %}
          </tbody>
          </table>
        </div>
      </div>

      <div class="mt-6 flex gap-4 justify-center">
        {% if symtab %}
        <button @click="showSymbols=true"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg font-semibold">
          üìä Ver tabla de s√≠mbolos
        </button>
        {% endif %}
        {% if source %}
        <button @click="showSource=true"
                class="bg-slate-700 hover:bg-slate-800 text-white px-5 py-2.5 rounded-lg font-semibold">
          üìÑ Ver archivo fuente
        </button>
        {% endif %}
      </div>
    </section>
    {% endif %}
  </div>

  <!-- MODALES -->
  <template x-if="showSymbols">
    <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50" x-transition>
      <div class="bg-white dark:bg-slate-900 w-11/12 max-w-6xl rounded-2xl p-6 shadow-xl relative">
        <button @click="showSymbols=false"
                class="absolute top-3 right-4 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200">‚úñ</button>
        <h2 class="text-2xl font-bold text-center mb-5">üìä Tabla de s√≠mbolos</h2>
        <div class="max-h-[70vh] overflow-y-auto border border-slate-200 dark:border-slate-700 rounded-lg">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 dark:bg-slate-800 sticky top-0">
              <tr class="text-left">
                <th class="px-4 py-2">Hash</th>
                <th class="px-4 py-2">Kind</th>
                <th class="px-4 py-2">Valor</th>
                <th class="px-4 py-2">L√≠nea</th>
                <th class="px-4 py-2">Col</th>
                <th class="px-4 py-2">Refs</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
              {% for e in symtab %}
              <tr class="hover:bg-slate-50 dark:hover:bg-slate-900/50">
                <td class="px-4 py-2 font-mono">{{ e.hash }}</td>
                <td class="px-4 py-2">{{ e.kind }}</td>
                <td class="px-4 py-2 font-mono">{{ e.value }}</td>
                <td class="px-4 py-2">{{ e.line }}</td>
                <td class="px-4 py-2">{{ e.col }}</td>
                <td class="px-4 py-2">{{ e.refs }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </template>

  <template x-if="showSource">
    <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50" x-transition>
      <div class="bg-white dark:bg-slate-900 w-11/12 max-w-4xl rounded-2xl p-6 shadow-xl relative">
        <button @click="showSource=false"
                class="absolute top-3 right-4 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200">‚úñ</button>
        <h2 class="text-2xl font-bold text-center mb-5">üìÑ Archivo fuente</h2>
        <pre class="max-h-[70vh] overflow-y-auto p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-mono leading-6 whitespace-pre-wrap">{{ source }}</pre>
      </div>
    </div>
  </template>

</body>
</html>
